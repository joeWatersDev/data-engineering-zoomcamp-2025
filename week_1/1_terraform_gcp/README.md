# GCP AND TERRAFORM

Simply, Terraform is infrastructure as code. It allows you to define/create infrastructure via a text/config file. Some advantages include:

- Ease of tracking infrastructure - all services listed in a file
- Ease of collaboration - multiple people can modify the infrastructure in highly visible ways by modifying the text file
- Reproducibility - just reuse the terraform file with some updated parameters

Terraform runs on your local machine, but takes advantage of infrastructure provided by a platform, including Google Cloud Platform (what we will be using), AWS, Kubernetes, Microsoft Azure, etc.

Communication with the platform/service is done via a "provider". Some code written by users or the org that facilitates your terraform connection to the platform.

Key Terraform commands:

- Init: Gets the needed providers
- Plan: What is being done/created
- Apply: Run what's in the tf files
- Destroy: Remove all infrastructure defined in tf files

### GCP SETUP

On the GCP end, we need to first set up a **service account* which allows GCP to authenticate our machine and has permissions to create resources.

We will start by making an account that has storage permissions (for GCP bucket) and permissions to run BigQuery.

![Service Account Permissions](https://github.com/joeWatersDev/data-engineering-zoomcamp-2025/blob/main/week_1/1_terraform_gcp/gcp_service_account.PNG)

We then create a key for our local machine for the service account. Keep it secret, keep it safe.

### MAIN.TF

Before we go further, make sure we have Terraform installed. On linux you can use the following (found [here](https://developer.hashicorp.com/terraform/install)):

```
wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
sudo apt update && sudo apt install terraform
```

Then, we create main.tf and set it up to connect to our GCP provider.

The basic config template can be found [here](https://registry.terraform.io/providers/hashicorp/google/latest/docs/guides/getting_started).

We need to add our project id and our key as arguments for the provider. After that we can run **terraform init** in terminal to get the provider.

Now lets add a resource to the file that we want as part of our infrastructure. A storage bucket! (Not like the Minecraft one.)

[Here](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/storage_bucket) is a template for adding one to our main.tf. We need to ensure our name argument is globally unique (we can use our project's name).

The lifecycle rule allows us to run some kind of command after a given number of days. We will keep the one that deletes a partial upload to the bucket if it has taken over a day to upload.

Once our main.tf is complete, we can run **terraform plan** in terminal. The output is a summary of what our main.tf file will do when deployed.

If there are no issues, deploy with **terraform apply**. You can also find the plan info in the tfstate file that is generated by the apply command. On GCP, you can now find the created bucket under our project's storage.

Once we no longer need the resources deployed on GCP, we can get rid of them with **terraform destroy**.